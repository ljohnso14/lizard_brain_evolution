---
title: "Ecological and Reproductive Predictors of Brain Size and Shape"
author: "Lauren E. Johnson & Donald B. Miles"
date: "11/4/2021"
output: html_document
---


1) Load appropriate packages 
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(tidyverse)
library(geomorph)
library(ggplot2)
library(cowplot)
library(ape)
library(phytools)
library(geiger)
library(tidytree)
library(picante)
library(pca3d)
library(Rphylopars)
library(dplyr)
library(ggpubr)
library(Hmisc)
library(corrplot)
```

2) Read in phylogeny data
make species ID's lowercase for future function that needs everythign lowercase
```{r}
s1.tree <- read.nexus("BrainGeomorph.nex")
s1.tree$tip.label <- tolower(s1.tree$tip.label) # make species Id's lowercase
plot(s1.tree)
```

Read in ecological and reproductive trait data
```{r}
s1.traits <- read.csv("./trait_data/Lizard_Trait_Data.csv", stringsAsFactors = F)
s1.traits$Id <- tolower(s1.traits$Id) #make species Id's lowercase
rownames(s1.traits) <- s1.traits$Id
head(s1.traits)
```

Impute missing values for the traits that are continuous variables and add into the trait data set 

```{r}
s1.traits.cont <- s1.traits[,c("Id", "maxSVL", "fSVL", "hatchlingSVL", 
                               "clutch_size", "PrecipSeasonality", "TempSeasonality")]

names(s1.traits.cont)[1] <- "species" # rename column from Id to species b/c phylpar requires it

s1.traits.imputed <- phylopars(trait_data = s1.traits.cont, tree = s1.tree)

str(s1.traits.imputed)
s1.traits.imputed$anc_recon

s1.traits.imputed.values <- s1.traits.imputed$anc_recon
s1.traits.imputed.values <- s1.traits.imputed.values[c(1:29),]

# s1.traits.imputed.values isn't a data frame, so needed to manually add imputed values to s1.traits
s1.traits["amphisbaena_scutigerum","fSVL"] = 325.891 
s1.traits["amphisbaena_scutigerum", "hatchlingSVL"] <- 98.704
s1.traits["amphisbaena_scutigerum","clutch_size"] <- 5.507
s1.traits["amphisbaena_scutigerum","PrecipSeasonality"] = 54.69 
s1.traits["amphisbaena_scutigerum","TempSeasonality"] = 6485.59



s1.traits["plestiodon_marginatus","hatchlingSVL"] <- 33.62
s1.traits["plestiodon_marginatus","clutch_size"] <- 4.78
s1.traits["plestiodon_marginatus","PrecipSeasonality"] <- 70.22
s1.traits["plestiodon_marginatus","TempSeasonality"] <- 3369.46

s1.traits["rieppeleon_brevicaudatus","hatchlingSVL"] <- 25.52

```




#######stopped here




Convert 2D array to 3D array
```{r}
s1.trim.3D <- as.matrix(s1.trim[,-(1)])
s1.trim.3D <- arrayspecs(s1.trim.3D, 61, 3)
```
the 3D array is [a, b, c], where...

a = landmark id (e.g., landmark 1, landmark 2, landmark 3, etc.) with a max of 61 values
b = the 3D coordinates (e.g., x coord, y coord, z coord) with a max of 3 values
c = species id coded by position in dataframe (e.g., Actonias_meleagris is 1)
species id           , , 1 
      
3D coordinates       [,1]     [,2]     [,3]
landmark 1           [1,] 9104.361 14396.24 7085.975
landmark 2           [2,] 9740.752 13144.82 6818.917


Create individual dataframes for each major brain region 
source for subsetting 3D arrays: http://adv-r.had.co.nz/Subsetting.html

Which landmarks ids (1 through 61) correspond to what major brain region
*3 and 45 are shared between Diencephalon, Mesencephalon, and Medulla Oblongata
(even though 3 isn't duplicated between them in their data - weird) 

Telencephalon
1:5, 10:14, 19:26
      
Diencephalon
6, 15, 43:45, 54:55, 61
      
Mesencephalon
7:8, 16:17, 27:28, 45, 48:49, 52:53, 58:59
      
Cerebellum
30:42, 50:51
      
Medulla oblongota
9, 18, 29, 45:47, 56:57, 60 

```{r}
tel <- s1.trim.3D[c(1:5, 10:14, 19:26), 1:3, 1:29]
dien <- s1.trim.3D[c(6, 15, 43:45, 54:55, 61), 1:3, 1:29]
mes <- s1.trim.3D[c(7:8, 16:17, 27:28, 45, 48:49, 52:53, 58:59), 1:3, 1:29]
cere <-s1.trim.3D[c(30:42, 50:51), 1:3, 1:29]
medob <- s1.trim.3D[c(9, 18, 29, 45:47, 56:57, 60), 1:3, 1:29]
```


Geomorphometric analyses using package 'geomorph'

Generalized Procrustes Analysis - how we get shape variables from landmark data (refer to gpagen details)

```{r}
S1.GPA <- gpagen(s1.trim.3D)
plot(S1.GPA) # ? does this plot all the species on top of each other?
```

Test the integration of the brain structures ('quantifying the degree of morphological integration between modular partitions of shape data')

landmarks of the brain assigned to brain region partitions
    tel  = A
    dien = B (the shared point 45 is classified under B)
    mes  = C
    cere = D
    medob= E

```{r}
brain.regions <- c('A', 'A', 'A', 'A', 'A',
                   'B',
                   'C', 'C',
                   'E',
                   'A', 'A', 'A', 'A', 'A',
                   'B',
                   'C', 'C', 
                   'E',
                   'A', 'A', 'A', 'A', 'A', 'A', 'A', 'A',
                   'C', 'C',
                   'E',
                   'D', 'D', 'D', 'D', 'D', 'D', 'D', 'D', 'D', 'D', 'D', 'D', 'D',
                   'B', 'B', 'B',
                   'E', 'E', 
                   'C', 'C',
                   'D', 'D',
                   'C', 'C',
                   'B', 'B',
                   'E', 'E',
                   'C', 'C',
                   'E',
                   'B')

Brain.IT <- integration.test(S1.GPA$coords, partition.gp = brain.regions, iter = 999)
summary(Brain.IT)
#picknplot.shape(plot(Brain.IT))

Brain.Mod <- modularity.test(S1.GPA$coords, partition.gp = brain.regions, iter = 999)
summary(Brain.Mod)
plot(Brain.Mod)

```

Refer to adam dean papers on how to interpret the results
  Adams, D.C. and M.L. Collyer. 2019. Comparing the strength of modular signal, and             evaluating alternative modular hypotheses, using covariance ratio effect sizes with         morphometric data. Evolution. 73:2352-2367.


